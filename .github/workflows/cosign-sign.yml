name: cosign-sign

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.0)"
        required: false

permissions:
  id-token: write
  contents: write

jobs:
  sign:
    runs-on: ubuntu-latest
    steps:
      - name: Install cosign
        uses: sigstore/cosign-installer@v3.8.1

      - name: Download release assets
        uses: robinraju/release-downloader@v1.10
        with:
          tag: ${{ github.event.release.tag_name || inputs.tag || github.ref_name }}
          repository: ${{ github.repository }}
          fileName: "*"
          out-file-path: relassets

      - name: Keyless sign artifacts (skip sums, json)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          shopt -s nullglob
          for f in relassets/*; do
            case "$f" in
              *.json|*SHA256SUMS*) continue ;;
            esac
            echo "Signing $f"
            cosign sign-blob --yes "$f" --output-signature "$f.sig" --output-certificate "$f.pem"
          done

      - name: Upload signatures as release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name || inputs.tag || github.ref_name }}
          files: |
            relassets/*.sig
            relassets/*.pem
